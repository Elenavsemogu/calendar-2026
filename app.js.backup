// app.js

// ------------------------------
// Utils
// ------------------------------
const qs = (sel, root = document) => root.querySelector(sel);
const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

function formatK(n) {
  if (!Number.isFinite(n)) return "";
  if (n >= 1000) return (Math.round(n / 100) / 10).toString() + "k";
  return String(n);
}

// ------------------------------
// State
// ------------------------------
let currentCitizenship = "RU";

// –î–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å": –±—É–¥–µ–º –ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –º–æ–¥–∞–ª–∫–µ
let currentEventId = null;

// ------------------------------
// Visa Matrix (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ Excel)
// ------------------------------
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞: citizenship -> destination -> {required, type, notes}
const VISA_MATRIX = {
  'RU': {
    'GB': { required: '–¥–∞', type: '–í–∏–∑–∞', notes: '–¢—Ä–µ–±—É–µ—Ç—Å—è Standard Visitor visa' },
    'BR': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'US': { required: '–¥–∞', type: '–í–∏–∑–∞ B1/B2', notes: '–ü–æ–¥–∞—á–∞ –≤ –ê—Å—Ç–∞–Ω–µ –∏–ª–∏ –í–∞—Ä—à–∞–≤–µ' },
    'PT': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞ ‚Ç¨90' },
    'AE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'AM': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '180 –¥–Ω–µ–π, –ï–ê–≠–°' },
    'PL': { required: '–∑–∞–ø—Ä–µ—Ç', type: '–í—ä–µ–∑–¥ –∑–∞–ø—Ä–µ—â—ë–Ω', notes: '–° 2022 –¥–ª—è —Ç—É—Ä–∏–∑–º–∞/–±–∏–∑–Ω–µ—Å–∞' },
    'UA': { required: '–¥–∞', type: '–í–∏–∑–∞', notes: '–í–∏–∑–æ–≤—ã–π —Ä–µ–∂–∏–º —Å 2022' },
    'CY': { required: '–¥–∞', type: '–ü—Ä–æ-–≤–∏–∑–∞', notes: '–ü—Ä–æ-–≤–∏–∑–∞ –æ–Ω–ª–∞–π–Ω –∏–ª–∏ —à–µ–Ω–≥–µ–Ω' },
    'RU': { required: '–Ω–µ—Ç', type: '–°–≤–æ—è —Å—Ç—Ä–∞–Ω–∞', notes: '' },
    'GE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '1 –≥–æ–¥ –±–µ–∑ –≤–∏–∑—ã' },
    'ES': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'MX': { required: '—ç–ª.—Ä–∞–∑—Ä–µ—à.', type: 'SAE', notes: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ –∞–≤–∏–∞' },
  },
  'UA': {
    'GB': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '6 –º–µ—Å—è—Ü–µ–≤ –±–µ–∑ –≤–∏–∑—ã' },
    'BR': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'US': { required: '–¥–∞', type: '–í–∏–∑–∞ B1/B2', notes: '–ü–æ–¥–∞—á–∞ –≤ –í–∞—Ä—à–∞–≤–µ/–ö—Ä–∞–∫–æ–≤–µ' },
    'PT': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '–®–µ–Ω–≥–µ–Ω –±–µ–∑–≤–∏–∑' },
    'AE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'AM': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '180 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'PL': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '–®–µ–Ω–≥–µ–Ω –±–µ–∑–≤–∏–∑' },
    'UA': { required: '–Ω–µ—Ç', type: '–°–≤–æ—è —Å—Ç—Ä–∞–Ω–∞', notes: '' },
    'CY': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '–®–µ–Ω–≥–µ–Ω –±–µ–∑–≤–∏–∑' },
    'RU': { required: '–¥–∞', type: '–í–∏–∑–∞', notes: '–í–∏–∑–æ–≤—ã–π —Ä–µ–∂–∏–º' },
    'GE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '1 –≥–æ–¥ –±–µ–∑ –≤–∏–∑—ã' },
    'ES': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '–®–µ–Ω–≥–µ–Ω –±–µ–∑–≤–∏–∑' },
    'MX': { required: '—ç–ª.—Ä–∞–∑—Ä–µ—à.', type: 'SAE', notes: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ' },
  },
  'BY': {
    'GB': { required: '–¥–∞', type: '–í–∏–∑–∞', notes: 'UK Visitor visa' },
    'BR': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'US': { required: '–¥–∞', type: '–í–∏–∑–∞ B1/B2', notes: '–ü–æ–¥–∞—á–∞ –≤ –í–∞—Ä—à–∞–≤–µ' },
    'PT': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'AE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'AM': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'PL': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'UA': { required: '–¥–∞', type: '–í–∏–∑–∞', notes: '–í–∏–∑–æ–≤—ã–π —Ä–µ–∂–∏–º' },
    'CY': { required: '–¥–∞', type: '–ü—Ä–æ-–≤–∏–∑–∞', notes: '–ü—Ä–æ-–≤–∏–∑–∞ –æ–Ω–ª–∞–π–Ω' },
    'RU': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '–°–æ—é–∑–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ' },
    'GE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '1 –≥–æ–¥ –±–µ–∑ –≤–∏–∑—ã' },
    'ES': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'MX': { required: '—ç–ª.—Ä–∞–∑—Ä–µ—à.', type: 'SAE', notes: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ' },
  },
  'KZ': {
    'GB': { required: '–¥–∞', type: '–í–∏–∑–∞', notes: 'UK Visitor visa' },
    'BR': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'US': { required: '–¥–∞', type: '–í–∏–∑–∞ B1/B2', notes: '–ü–æ–¥–∞—á–∞ –≤ –ê—Å—Ç–∞–Ω–µ' },
    'PT': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'AE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'AM': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '180 –¥–Ω–µ–π, –ï–ê–≠–°' },
    'PL': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'UA': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã' },
    'CY': { required: '–¥–∞', type: '–ü—Ä–æ-–≤–∏–∑–∞', notes: '–ü—Ä–æ-–≤–∏–∑–∞ –æ–Ω–ª–∞–π–Ω' },
    'RU': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '–ï–ê–≠–°' },
    'GE': { required: '–Ω–µ—Ç', type: '–ë–µ–∑–≤–∏–∑', notes: '1 –≥–æ–¥ –±–µ–∑ –≤–∏–∑—ã' },
    'ES': { required: '–¥–∞', type: '–®–µ–Ω–≥–µ–Ω', notes: '–®–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞' },
    'MX': { required: '—ç–ª.—Ä–∞–∑—Ä–µ—à.', type: 'SAE', notes: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ' },
  },
};

// –ú–∞–ø–ø–∏–Ω–≥ conf_id -> country_code (–¥–ª—è –≤–∏–∑–æ–≤–æ–π –ª–æ–≥–∏–∫–∏)
const CONF_COUNTRIES = {
  'igb_live_2026_london': 'GB',
  'sbc_rio_2026': 'BR',
  'sbc_americas_2026': 'US',
  'sbc_lisbon_2026': 'PT',
  'affiliate_world_dubai_2026': 'AE',
  'mac_yerevan_2026': 'AM',
  'conversion_warsaw_2026': 'PL',
  'conversion_kyiv_2026': 'UA',
  'conversion_cyprus_2026': 'CY',
  'broconf_sochi_2026': 'RU',
  'ggate_tbilisi_2026': 'GE',
  'affpapa_madrid_2026': 'ES',
  'affpapa_cancun_2026': 'MX',
  'g2e_las_vegas_2026': 'US',
};

// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (deprecated)
const VISA_RULES = {};
Object.keys(VISA_MATRIX).forEach(citizenship => {
  VISA_RULES[citizenship] = {};
  Object.keys(VISA_MATRIX[citizenship]).forEach(country => {
    const info = VISA_MATRIX[citizenship][country];
    VISA_RULES[citizenship][country] = info.required === '–Ω–µ—Ç' ? 'no' :
                                        info.required === '–¥–∞' ? 'yes' :
                                        'unknown';
  });
});

// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
function getVisaStatus(citizenship, country) {
  const c = (citizenship || "").toUpperCase();
  const cc = (country || "").toUpperCase();
  return VISA_RULES?.[c]?.[cc] || "unknown";
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –≤–∏–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function getVisaInfo(citizenship, country) {
  const c = (citizenship || "").toUpperCase();
  const cc = (country || "").toUpperCase();
  return VISA_MATRIX?.[c]?.[cc] || null;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è –≤–∏–∑–æ–≤–æ–≥–æ —Ç–µ–≥–∞
function getVisaTagHTML(visaInfo) {
  if (!visaInfo) {
    return '<span class="px-2 py-1 rounded-full text-xs bg-gray-500/20 text-gray-400" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—Ç–æ—á–Ω—è–µ—Ç—Å—è">? –£—Ç–æ—á–Ω–∏—Ç—å</span>';
  }

  const colorClasses = {
    '–Ω–µ—Ç': 'bg-green-500/20 text-green-400 border-green-500/30',
    '–¥–∞': 'bg-red-500/20 text-red-400 border-red-500/30',
    '–∑–∞–ø—Ä–µ—Ç': 'bg-red-700/30 text-red-300 border-red-700/40',
    '—ç–ª.—Ä–∞–∑—Ä–µ—à.': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
  };

  const labels = {
    '–Ω–µ—Ç': '‚úì –ë–µ–∑ –≤–∏–∑—ã',
    '–¥–∞': '‚ö† –í–∏–∑–∞',
    '–∑–∞–ø—Ä–µ—Ç': '‚úï –í—ä–µ–∑–¥ –∑–∞–ø—Ä–µ—â—ë–Ω',
    '—ç–ª.—Ä–∞–∑—Ä–µ—à.': '‚ö° –≠–ª. —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ',
  };

  const colorClass = colorClasses[visaInfo.required] || 'bg-gray-500/20 text-gray-400';
  const label = labels[visaInfo.required] || visaInfo.type;
  const title = visaInfo.notes || visaInfo.type;

  return `<span class="px-2 py-1 rounded-full text-xs border ${colorClass}" title="${title}">${label}</span>`;
}

function applyVisaTag(el, status, countryCode) {
  // el ‚Äî —ç—Ç–æ span —Å data-visa-tag="XX"
  el.classList.remove("tag-visa", "tag-no-visa");
  const flag = countryCode ? ` ${countryCode}` : "";

  if (status === "no") {
    el.classList.add("tag-no-visa");
    // –æ—Å—Ç–∞–≤–∏–º —Ç–≤–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω "No Visa ..."
    // –µ—Å–ª–∏ —Ç–∞–º —É–∂–µ –µ—Å—Ç—å —ç–º–æ–¥–∑–∏ —Ñ–ª–∞–≥–∞ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º
    if (!el.textContent.toLowerCase().includes("no visa")) el.textContent = `No Visa${flag}`;
  } else if (status === "yes") {
    el.classList.add("tag-visa");
    if (!el.textContent.toLowerCase().includes("visa")) el.textContent = `Visa${flag}`;
  } else {
    el.classList.add("tag-visa");
    el.textContent = "Check visa";
  }
}

function updateAllVisaTags() {
  qsa("[data-visa-tag]").forEach((tag) => {
    const cc = tag.getAttribute("data-visa-tag");

    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –≤–∏–∑–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É
    const visaInfo = getVisaInfo(currentCitizenship, cc);
    if (visaInfo) {
      // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
      tag.outerHTML = getVisaTagHTML(visaInfo);
    } else {
      // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
      const status = getVisaStatus(currentCitizenship, cc);
      applyVisaTag(tag, status, cc);
    }
  });
}

// ------------------------------
// Filters
// ------------------------------
const TIER_FILTERS = [
  { key: "any", label: "–í—Å–µ" },
  { key: "mega", label: "20k+" },
  { key: "large", label: "8k+" },
  { key: "mid", label: "<8k" }
];

const VISA_FILTERS = [
  { key: "any", label: "–ù–µ –≤–∞–∂–Ω–æ" },
  { key: "no", label: "–¢–æ–ª—å–∫–æ –±–µ–∑ –≤–∏–∑—ã" },
  { key: "yes", label: "–¢–æ–ª—å–∫–æ —Å –≤–∏–∑–æ–π" },
  { key: "unknown", label: "–£—Ç–æ—á–Ω–∏—Ç—å" }
];

let tierFilterIndex = 0; // any
let visaFilterIndex = 0; // any

function updateFilterLabels() {
  const sizeBtn = qs("#filterSizeBtn");
  const visaBtn = qs("#filterVisaBtn");
  if (sizeBtn) sizeBtn.textContent = `–†–∞–∑–º–µ—Ä: ${TIER_FILTERS[tierFilterIndex].label}`;
  if (visaBtn) visaBtn.textContent = `–í–∏–∑–∞: ${VISA_FILTERS[visaFilterIndex].label}`;
}

function applyFilters() {
  const tierKey = TIER_FILTERS[tierFilterIndex].key;
  const visaKey = VISA_FILTERS[visaFilterIndex].key;

  qsa('[data-filterable="1"]').forEach((el) => {
    const elTier = (el.getAttribute("data-tier") || "").toLowerCase();
    const elCountry = (el.getAttribute("data-country") || "").toUpperCase();

    let tierOk = true;
    if (tierKey !== "any") tierOk = (elTier === tierKey);

    let visaOk = true;
    if (visaKey !== "any") {
      if (!elCountry) {
        // –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞ ‚Äî –Ω–µ –ª–æ–º–∞–µ–º, –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–º
        visaOk = true;
      } else {
        const status = getVisaStatus(currentCitizenship, elCountry);
        visaOk = (status === visaKey);
      }
    }

    if (tierOk && visaOk) el.classList.remove("hidden");
    else el.classList.add("hidden");
  });

  // Update button UI after filter change
  if (typeof updateButtonUI === 'function') {
    updateButtonUI();
  }
}

// ------------------------------
// Modal open/close + tabs
// ------------------------------
function openModal() {
  const overlay = qs("#modalOverlay");
  const bg = qs("#modalBg");
  const panel = qs("#modalPanel");
  if (!overlay || !bg || !panel) return;

  overlay.classList.remove("hidden");
  setTimeout(() => {
    bg.classList.remove("opacity-0");
    panel.classList.remove("translate-x-full");
  }, 10);

  document.body.classList.add("modal-open");
}

function closeModal() {
  const overlay = qs("#modalOverlay");
  const bg = qs("#modalBg");
  const panel = qs("#modalPanel");
  if (!overlay || !bg || !panel) return;

  bg.classList.add("opacity-0");
  panel.classList.add("translate-x-full");

  setTimeout(() => {
    overlay.classList.add("hidden");
  }, 300);

  document.body.classList.remove("modal-open");
  currentEventId = null; // —Å–±—Ä–æ—Å "—Ç–µ–∫—É—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è"
}

function setActiveTab(tabId) {
  qsa(".tab-content").forEach((el) => el.classList.remove("active"));
  qsa(".tab-btn").forEach((el) => el.classList.remove("active"));

  const tab = qs(`#${tabId}`);
  const btn = qs(`[data-tab-btn="${tabId}"]`);

  if (tab) tab.classList.add("active");
  if (btn) btn.classList.add("active");
}

// ------------------------------
// Event data (MVP —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –º–æ–¥–∞–ª–∫–µ)
// ------------------------------
// –¢—ã —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –º–æ–¥–∞–ª–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å data-event-id.
// –î–∞–≤–∞–π –¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ç. –ü–æ–∑–∂–µ –≤—ã–Ω–µ—Å–µ–º –≤ events.json.
const EVENTS = {
  "igb_live_2026_london": {
    title: "iGB L!VE",
    country: "GB",
    city: "London",
    datesLabel: "1‚Äì2 –ò—é–ª 2026",
    heroImg: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "15k+",
    badgeType: "MAJOR EVENT",
    startISO: "2026-07-01T09:00:00Z",
    endISO: "2026-07-02T18:00:00Z",
    description: "iGB L!VE is one of the largest iGaming exhibitions, featuring 15,000+ attendees and 300+ exhibitors. ExCeL London.",
    weather: {
      temp: "18-22",
      description: "–¢—ë–ø–ª–æ–µ –ª–µ—Ç–æ, –≤–æ–∑–º–æ–∂–Ω—ã –¥–æ–∂–¥–∏"
    },
    restaurants: [
      {
        name: "Plateau Canary Wharf",
        vibe: "–ø–æ—Å–∏–¥–µ—Ç—å",
        avgCheck: "¬£100‚Äì300",
        description: "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –≤ Canary Wharf, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ–ª–æ–≤–æ–≥–æ —É–∂–∏–Ω–∞ –∏ —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞.",
        img: "https://images.unsplash.com/photo-1552566626-52f8b828add9?q=80&w=200&auto=format&fit=crop"
      },
      {
        name: "Boisdale Canary Wharf",
        vibe: "–≥—Ä–æ–º–∫–æ",
        avgCheck: "¬£100‚Äì300",
        description: "–®–æ—Ç–ª–∞–Ω–¥—Å–∫–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –∂–∏–≤—ã–º –¥–∂–∞–∑–æ–º –∏ –±–∞—Ä–æ–º, –ø–æ–ø—É–ª—è—Ä–µ–Ω –¥–ª—è –≤–µ—á–µ—Ä–Ω–∏—Ö –≤—Å—Ç—Ä–µ—á –ø–æ—Å–ª–µ –∫–æ–Ω—Ñ—ã.",
        img: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=200&auto=format&fit=crop"
      },
      {
        name: "Electric Shuffle Canary Wharf",
        vibe: "–ø–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å",
        avgCheck: "¬£50‚Äì100",
        description: "–ë–∞—Ä —Å –∞–∫—Ç–∏–≤–Ω–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π, –∫–æ–∫—Ç–µ–π–ª–∏ –∏ shuffleboard, —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è.",
        img: "https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?q=80&w=200&auto=format&fit=crop"
      },
      {
        name: "The Oiler Bar",
        vibe: "–ø–æ—Å–∏–¥–µ—Ç—å",
        avgCheck: "¬£50‚Äì100",
        description: "–ö–æ–∫—Ç–µ–π–ª—å-–±–∞—Ä —Ä—è–¥–æ–º —Å ExCeL, —É–¥–æ–±–µ–Ω –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤—Å—Ç—Ä–µ—á –ø–æ—Å–ª–µ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–Ω—è.",
        img: "https://images.unsplash.com/photo-1514933651103-005eec06c04b?q=80&w=200&auto=format&fit=crop"
      },
      {
        name: "The Gun Docklands",
        vibe: "—Ç–∏—Ö–æ",
        avgCheck: "¬£100‚Äì300",
        description: "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞–± –Ω–∞ –±–µ—Ä–µ–≥—É –¢–µ–º–∑—ã, —Å–ø–æ–∫–æ–π–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ —É–∂–∏–Ω–∞.",
        img: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=200&auto=format&fit=crop"
      }
    ],
    brands: [
      "CoolAffs", "EcoPayz", "Mate Affiliates", "Melbet", "1Bet", "22Bet Partners",
      "2rbo Affiliates", "50-Partners", "ABC World Media", "Ace Revenue", "Adtucon",
      "AffFellow", "Affigates", "AffiliatePark", "Affilka", "Affiverse", "AffRepublic",
      "Agency Aurora", "AGIMEG", "Alamy & Podium", "Alea", "Alpha Affiliates", "Altenar",
      "Amusnet", "Asia Casino news", "Astro Affiliate", "Atlaslive", "Aviatrix",
      "Bazoom Group", "BC.Game"
    ],
    sideEvents: []
  },
  "mac_yerevan_2026": {
    title: "MAC Yerevan",
    country: "AM",
    city: "Yerevan",
    datesLabel: "25‚Äì27 –ú–∞–π 2026",
    heroImg: "static/MAC_Yerevan.jpeg",
    attendeesLabel: "5k+",
    badgeType: "MAJOR EVENT",
    startISO: "2026-05-25T09:00:00Z",
    endISO: "2026-05-27T18:00:00Z",
    description: "MAC Yerevan ‚Äî –∫—Ä—É–ø–Ω–µ–π—à–∞—è CIS-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –≤ —Å—Ñ–µ—Ä–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ –∞—Ñ—Ñ–∏–ª–µ–π—Ç–∞. 5,000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, Meridian Expo.",
    weather: {
      temp: "22-28",
      description: "–¢—ë–ø–ª–∞—è –ø–æ–∑–¥–Ω—è—è –≤–µ—Å–Ω–∞, —Å–æ–ª–Ω–µ—á–Ω–æ"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "sbc_rio_2026": {
    title: "SBC Summit Rio",
    country: "BR",
    city: "Rio de Janeiro",
    datesLabel: "3‚Äì5 –ú–∞—Ä 2026",
    heroImg: "https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "15k+",
    badgeType: "MAJOR EVENT",
    startISO: "2026-03-03T09:00:00Z",
    endISO: "2026-03-05T18:00:00Z",
    description: "SBC Summit Rio ‚Äî –∫—Ä—É–ø–Ω–µ–π—à–µ–µ —Å–æ–±—ã—Ç–∏–µ –≤ –ª–∞—Ç–∏–Ω–æ–∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–π –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ iGaming.",
    weather: {
      temp: "28-32",
      description: "–ñ–∞—Ä–∫–æ –∏ –≤–ª–∞–∂–Ω–æ, —Å–µ–∑–æ–Ω –¥–æ–∂–¥–µ–π –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "sbc_americas_2026": {
    title: "SBC Summit Americas",
    country: "US",
    city: "Fort Lauderdale",
    datesLabel: "9‚Äì11 –ò—é–Ω 2026",
    heroImg: "https://images.unsplash.com/photo-1549719386-74dfcbf7dbed?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "10k+",
    badgeType: "MAJOR EVENT",
    startISO: "2026-06-09T09:00:00Z",
    endISO: "2026-06-11T18:00:00Z",
    description: "SBC Summit Americas ‚Äî –∫–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–µ–≤–µ—Ä–æ–∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ —Ä—ã–Ω–∫–∞ iGaming.",
    weather: {
      temp: "28-33",
      description: "–ñ–∞—Ä–∫–æ –∏ –≤–ª–∞–∂–Ω–æ, –Ω–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞ —É—Ä–∞–≥–∞–Ω–æ–≤"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "sbc_lisbon_2026": {
    title: "SBC Summit",
    country: "PT",
    city: "Lisbon",
    datesLabel: "29 –°–µ–Ω ‚Äì 1 –û–∫—Ç 2026",
    heroImg: "https://images.unsplash.com/photo-1509927083800-11337a1525a4?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "25k+",
    badgeType: "MEGA EVENT",
    startISO: "2026-09-29T09:00:00Z",
    endISO: "2026-10-01T18:00:00Z",
    description: "SBC Summit Lisbon ‚Äî –∫—Ä—É–ø–Ω–µ–π—à–µ–µ –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ —Å—Ñ–µ—Ä–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–≥–æ –±–µ—Ç—Ç–∏–Ω–≥–∞ –∏ iGaming. 25,000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.",
    weather: {
      temp: "20-25",
      description: "–¢—ë–ø–ª–∞—è –æ—Å–µ–Ω—å, —Å–æ–ª–Ω–µ—á–Ω–æ"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "affiliate_world_dubai_2026": {
    title: "Affiliate World Dubai",
    country: "AE",
    city: "Dubai",
    datesLabel: "4‚Äì5 –ú–∞—Ä 2026",
    heroImg: "https://images.unsplash.com/photo-1512453979798-5ea266f8880c?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "7k+",
    badgeType: "MAJOR EVENT",
    startISO: "2026-03-04T09:00:00Z",
    endISO: "2026-03-05T18:00:00Z",
    description: "Affiliate World Dubai ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è –∞—Ñ—Ñ–∏–ª–µ–π—Ç-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ performance marketing.",
    weather: {
      temp: "24-28",
      description: "–ü—Ä–∏—è—Ç–Ω–æ —Ç–µ–ø–ª–æ, –Ω–∏–∑–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "conversion_warsaw_2026": {
    title: "Conversion Conf Warsaw",
    country: "PL",
    city: "Warsaw",
    datesLabel: "1‚Äì2 –ê–ø—Ä 2026",
    heroImg: "https://images.unsplash.com/photo-1581094794329-c8112a89af12?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "3k+",
    badgeType: "EVENT",
    startISO: "2026-04-01T09:00:00Z",
    endISO: "2026-04-02T18:00:00Z",
    description: "Conversion Conf Warsaw ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ conversion optimization –∏ affiliate marketing.",
    weather: {
      temp: "8-14",
      description: "–ü—Ä–æ—Ö–ª–∞–¥–Ω–∞—è –≤–µ—Å–Ω–∞, –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "conversion_cyprus_2026": {
    title: "Conversion Conf Cyprus",
    country: "CY",
    city: "Limassol",
    datesLabel: "23‚Äì24 –ò—é–ª 2026",
    heroImg: "https://images.unsplash.com/photo-1580837119756-563d608dd119?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "1.5k+",
    badgeType: "EVENT",
    startISO: "2026-07-23T09:00:00Z",
    endISO: "2026-07-24T18:00:00Z",
    description: "Conversion Conf Cyprus ‚Äî –ª–µ—Ç–Ω—è—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è –∞—Ñ—Ñ–∏–ª–µ–π—Ç-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤. –û—Ç–µ–ª—å Parklane.",
    weather: {
      temp: "28-32",
      description: "–ñ–∞—Ä–∫–æ–µ —Å—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–æ–µ –ª–µ—Ç–æ"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "broconf_sochi_2026": {
    title: "Broconf",
    country: "RU",
    city: "Sochi",
    datesLabel: "25‚Äì26 –ê–ø—Ä 2026",
    heroImg: "https://images.unsplash.com/photo-1580674285054-bed31e145f59?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "4k+",
    badgeType: "EVENT",
    startISO: "2026-04-25T09:00:00Z",
    endISO: "2026-04-26T18:00:00Z",
    description: "Broconf ‚Äî –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–∏–∫–æ–≤ –∏ –∞—Ñ—Ñ–∏–ª–µ–π—Ç-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤. Red Arena, –°–æ—á–∏.",
    weather: {
      temp: "16-22",
      description: "–¢—ë–ø–ª–∞—è –≤–µ—Å–Ω–∞, –≤–æ–∑–º–æ–∂–Ω—ã –¥–æ–∂–¥–∏"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "ggate_tbilisi_2026": {
    title: "G Gate",
    country: "GE",
    city: "Tbilisi",
    datesLabel: "26‚Äì27 –ò—é–Ω 2026",
    heroImg: "https://images.unsplash.com/photo-1596422846543-75c6fc197f07?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "7k+",
    badgeType: "MAJOR EVENT",
    startISO: "2026-06-26T09:00:00Z",
    endISO: "2026-06-27T18:00:00Z",
    description: "G Gate Tbilisi ‚Äî —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è iGaming –∏ affiliate marketing.",
    weather: {
      temp: "26-32",
      description: "–ñ–∞—Ä–∫–æ–µ –ª–µ—Ç–æ, —Å—É—Ö–æ"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "affpapa_madrid_2026": {
    title: "AffPapa Conference Madrid",
    country: "ES",
    city: "Madrid",
    datesLabel: "18‚Äì20 –ú–∞–π 2026",
    heroImg: "https://images.unsplash.com/photo-1539037116277-4db20889f2d4?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "2.3k+",
    badgeType: "EVENT",
    startISO: "2026-05-18T09:00:00Z",
    endISO: "2026-05-20T18:00:00Z",
    description: "AffPapa Conference Madrid ‚Äî B2B-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è iGaming –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤.",
    weather: {
      temp: "20-26",
      description: "–¢—ë–ø–ª–∞—è –ø–æ–∑–¥–Ω—è—è –≤–µ—Å–Ω–∞, —Å–æ–ª–Ω–µ—á–Ω–æ"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "affpapa_cancun_2026": {
    title: "AffPapa Conference Cancun",
    country: "MX",
    city: "Cancun",
    datesLabel: "23‚Äì25 –ù–æ—è 2026",
    heroImg: "https://images.unsplash.com/photo-1569169348447-f87efe4c46d7?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "400+",
    badgeType: "EVENT",
    startISO: "2026-11-23T09:00:00Z",
    endISO: "2026-11-25T18:00:00Z",
    description: "AffPapa Conference Cancun ‚Äî –∫–∞–º–µ—Ä–Ω–∞—è LATAM-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è networking.",
    weather: {
      temp: "26-30",
      description: "–¢–µ–ø–ª–æ, –∫–æ–Ω–µ—Ü —Å–µ–∑–æ–Ω–∞ –¥–æ–∂–¥–µ–π"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  },
  "g2e_las_vegas_2026": {
    title: "Global Gaming Expo",
    country: "US",
    city: "Las Vegas",
    datesLabel: "29 –°–µ–Ω ‚Äì 1 –û–∫—Ç 2026",
    heroImg: "https://images.unsplash.com/photo-1515515464134-f67d4b49a882?q=80&w=800&auto=format&fit=crop",
    attendeesLabel: "25k+",
    badgeType: "MEGA EVENT",
    startISO: "2026-09-29T09:00:00Z",
    endISO: "2026-10-01T18:00:00Z",
    description: "Global Gaming Expo (G2E) ‚Äî –∫—Ä—É–ø–Ω–µ–π—à–∞—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –¥–ª—è land-based gaming –∏–Ω–¥—É—Å—Ç—Ä–∏–∏. The Venetian Expo.",
    weather: {
      temp: "22-32",
      description: "–ñ–∞—Ä–∫–æ –¥–Ω—ë–º, –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ –Ω–æ—á—å—é, —Å—É—Ö–æ"
    },
    restaurants: [],
    brands: [],
    sideEvents: []
  }
};

function populateModal(eventId) {
  const ev = EVENTS[eventId];
  if (!ev) return;

  currentEventId = eventId;

  const hero = qs("#modalHeroImg");
  const title = qs("#modalTitle");
  const loc = qs("#modalLocationLine");
  const statAtt = qs("#modalStatAttendees");
  const badgeType = qs("#modalBadgeType");
  const badgeVisa = qs("#modalBadgeVisa");

  if (hero) hero.src = ev.heroImg || "";
  if (title) title.textContent = ev.title || "";
  if (loc) loc.textContent = `üìç ${ev.country}, ${ev.city} ‚Ä¢ ${ev.datesLabel}`;
  if (statAtt) statAtt.textContent = ev.attendeesLabel || "";

  if (badgeType) badgeType.textContent = ev.badgeType || "EVENT";

  if (badgeVisa) {
    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –≤–∏–∑–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É
    const visaInfo = getVisaInfo(currentCitizenship, ev.country);

    if (visaInfo) {
      // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
      const colorClasses = {
        '–Ω–µ—Ç': 'bg-green-500/20 text-green-400 border-green-500/30',
        '–¥–∞': 'bg-red-500/20 text-red-300 border-red-500/30',
        '–∑–∞–ø—Ä–µ—Ç': 'bg-red-700/30 text-red-300 border-red-700/40',
        '—ç–ª.—Ä–∞–∑—Ä–µ—à.': 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30',
      };

      const labels = {
        '–Ω–µ—Ç': '–ë–µ–∑ –≤–∏–∑—ã',
        '–¥–∞': '–ù—É–∂–Ω–∞ –≤–∏–∑–∞',
        '–∑–∞–ø—Ä–µ—Ç': '–í—ä–µ–∑–¥ –∑–∞–ø—Ä–µ—â—ë–Ω',
        '—ç–ª.—Ä–∞–∑—Ä–µ—à.': '–≠–ª. —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ',
      };

      badgeVisa.textContent = labels[visaInfo.required] || visaInfo.type;
      badgeVisa.className = `${colorClasses[visaInfo.required] || 'bg-gray-500/20 text-gray-300'} text-[10px] font-bold px-3 py-1 rounded-full border`;
      badgeVisa.title = visaInfo.notes || '';
    } else {
      // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
      const status = getVisaStatus(currentCitizenship, ev.country);
      if (status === "no") {
        badgeVisa.textContent = "–ë–µ–∑ –≤–∏–∑—ã";
        badgeVisa.className = "bg-green-500/20 text-green-400 text-[10px] font-bold px-3 py-1 rounded-full border border-green-500/30";
      } else if (status === "yes") {
        badgeVisa.textContent = "–ù—É–∂–Ω–∞ –≤–∏–∑–∞";
        badgeVisa.className = "bg-red-500/20 text-red-300 text-[10px] font-bold px-3 py-1 rounded-full border border-red-500/30";
      } else {
        badgeVisa.textContent = "–£—Ç–æ—á–Ω–∏—Ç—å –≤–∏–∑—É";
        badgeVisa.className = "bg-yellow-500/20 text-yellow-300 text-[10px] font-bold px-3 py-1 rounded-full border border-yellow-500/30";
      }
    }
  }

  // Weather display
  if (ev.weather && ev.weather.temp !== '‚Äî') {
    const weatherContainer = qs("#modalWeatherContainer");
    if (weatherContainer) {
      const weatherHTML = `
        <div class="flex items-center gap-2 text-sm text-gray-400 mt-2">
          <span>üå°Ô∏è</span>
          <span>${ev.weather.temp}¬∞C</span>
          <span class="text-gray-600">‚Ä¢</span>
          <span>${ev.weather.description}</span>
        </div>
      `;
      weatherContainer.innerHTML = weatherHTML;
    }
  } else {
    // Clear weather container if no weather data
    const weatherContainer = qs("#modalWeatherContainer");
    if (weatherContainer) {
      weatherContainer.innerHTML = '';
    }
  }

  // Populate tabs
  populateRestaurantsTab(ev.restaurants || []);
  populateSideEventsTab(ev.sideEvents || []);
  populateBrandsTab(ev.brands || []);

  // Update tab button labels with counts
  const eventsBtn = qs('[data-tab-btn="events"]');
  if (eventsBtn) {
    const count = (ev.sideEvents || []).length;
    eventsBtn.textContent = count > 0 ? `–°–∞–π–¥-–∏–≤–µ–Ω—Ç—ã (${count})` : "–°–∞–π–¥-–∏–≤–µ–Ω—Ç—ã";
  }

  // —Ç–∞–± –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  setActiveTab("guide");
}

function populateRestaurantsTab(restaurants) {
  const container = qs("#guide");
  if (!container) return;

  if (!restaurants || restaurants.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-400">
        <p class="text-sm">–°–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±–ª–∏–∂–µ –∫ –¥–∞—Ç–∞–º –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏</p>
      </div>
    `;
    return;
  }

  const vibeMap = {
    '—Ç–∏—Ö–æ': 'ü§´ –¢–∏—Ö–æ',
    '–ø–æ—Å–∏–¥–µ—Ç—å': '‚òï –ü–æ—Å–∏–¥–µ—Ç—å',
    '–≥—Ä–æ–º–∫–æ': 'üéµ –ì—Ä–æ–º–∫–æ',
    '–ø–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å': 'üíÉ –ü–æ—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å'
  };

  let html = `
    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
      üçΩ –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –¥–ª—è –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞
      <span class="uni-tag uni-tag-gray">ü§ù –î–ª—è –≤—Å—Ç—Ä–µ—á</span>
    </h3>
  `;

  restaurants.forEach(r => {
    const vibeLabel = vibeMap[r.vibe] || r.vibe;
    html += `
      <div class="relative flex gap-4 p-3 rounded-xl border border-[#2A2E37] bg-[#0F1115] mb-3">
        <img src="${r.img || 'https://images.unsplash.com/photo-1552566626-52f8b828add9?q=80&w=200&auto=format&fit=crop'}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" alt="${r.name}" loading="lazy" decoding="async">
        <div class="flex-1 flex flex-col">
          <div class="font-bold text-white text-[15px] mb-1">${r.name}</div>
          ${vibeLabel ? `<span class="vibe-tag mb-2">${vibeLabel}</span>` : ''}
          <div class="text-xs text-gray-400 leading-relaxed mt-auto">${r.description || ''}</div>
        </div>
        ${r.avgCheck ? `<div class="absolute bottom-3 right-3"><span class="restaurant-check-pill">${r.avgCheck}</span></div>` : ''}
      </div>
    `;
  });

  container.innerHTML = html;
}

function populateSideEventsTab(sideEvents) {
  const container = qs("#events");
  if (!container) return;

  if (!sideEvents || sideEvents.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-400">
        <p class="text-sm">–°–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ side events –∏ afterparty</p>
      </div>
    `;
    return;
  }

  let html = '';
  sideEvents.forEach(e => {
    html += `
      <div class="bg-gradient-to-br from-gray-900 to-black dark:from-darkbg dark:to-darksurface text-white p-5 rounded-2xl relative overflow-hidden shadow-lg group mb-4">
        <div class="relative z-10 flex justify-between items-start">
          <div>
            <div class="flex gap-2 mb-2">
              <span class="uni-tag uni-tag-accent">${e.badge || 'üéâ EVENT'}</span>
            </div>
            <h3 class="text-2xl font-extrabold mb-1">${e.title}</h3>
            <p class="text-sm text-gray-300 mb-4 flex items-center gap-1">${e.location || ''}</p>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

function populateBrandsTab(brands) {
  const container = qs("#brands");
  if (!container) return;

  if (!brands || brands.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-400">
        <p class="text-sm">–°–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –±—Ä–µ–Ω–¥–æ–≤</p>
      </div>
    `;
    return;
  }

  // Category mapping with ruLabel and ruHint
  const categoryConfig = {
    'payments': { label: '–ü–ª–∞—Ç–µ–∂–∏', hint: '–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ —Ñ–∏–Ω—Ç–µ—Ö' },
    'affiliate network': { label: '–ü–∞—Ä—Ç–Ω—ë—Ä–∫–∞', hint: '–°–µ—Ç—å –∏ –æ—Ñ—Ñ–µ—Ä—ã –¥–ª—è –∞—Ñ—Ñ–∏–ª–∏–∞—Ç–æ–≤' },
    'affiliate program': { label: '–ü–∞—Ä—Ç–Ω. –ø—Ä–æ–≥—Ä–∞–º–º–∞', hint: '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—Ä–µ–Ω–¥–∞' },
    'operator': { label: '–û–ø–µ—Ä–∞—Ç–æ—Ä', hint: '–ö–∞–∑–∏–Ω–æ/–±—É–∫–º–µ–∫–µ—Ä' },
    'platform provider': { label: '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞', hint: 'B2B –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞/–ø—Ä–æ–≤–∞–π–¥–µ—Ä' },
    'adtech': { label: 'AdTech', hint: '–¢—Ä–µ–∫–µ—Ä—ã, –∞–Ω—Ç–∏—Ñ—Ä–æ–¥, —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã' },
    'media': { label: '–ú–µ–¥–∏–∞', hint: '–°–ú–ò/–∫–æ–º—å—é–Ω–∏—Ç–∏/–ø–∞–±–ª–∏—à–µ—Ä' },
    'marketing agency': { label: '–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ', hint: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ —Ä–æ—Å—Ç' },
    'affiliate software': { label: '–°–æ—Ñ—Ç', hint: '–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞—Ñ—Ñ–æ–≤' }
  };

  // Smart category detection by brand name
  function detectCategory(brandName) {
    const name = brandName.toLowerCase();
    if (name.includes('pay') || name.includes('wallet') || name.includes('bank')) return categoryConfig['payments'];
    if (name.includes('affiliate') || name.includes('affil')) return categoryConfig['affiliate network'];
    if (name.includes('partners')) return categoryConfig['affiliate program'];
    if (name.includes('bet') || name.includes('casino') || name.includes('gaming')) return categoryConfig['operator'];
    if (name.includes('media') || name.includes('news')) return categoryConfig['media'];
    if (name.includes('revenue') || name.includes('aff')) return categoryConfig['affiliate network'];
    return { label: 'iGaming', hint: 'iGaming —Ä–µ—à–µ–Ω–∏—è' };
  }

  function renderBrandCard(brand) {
    const initials = brand.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
    const cat = detectCategory(brand);

    return `
      <div class="brand-card aspect-square rounded-xl bg-[#0F1115] border border-[#2A2E37] flex flex-col items-center justify-center p-3 text-center hover:border-accent/50 transition relative cursor-pointer group">
        <div class="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center text-accent font-bold mb-2 text-sm group-hover:bg-accent/30 transition">
          ${initials}
        </div>
        <div class="text-[14px] font-semibold text-white leading-tight mb-2 px-1">${brand}</div>
        <span class="brand-category-pill">${cat.label}</span>
        <div class="brand-tooltip">${brand} ‚Äî ${cat.hint}</div>
      </div>
    `;
  }

  let html = '<div id="brandsGrid" class="grid grid-cols-4 gap-3">';

  // Show first 15 brands
  const displayBrands = brands.slice(0, 15);
  const remaining = brands.length - 15;

  displayBrands.forEach(brand => {
    html += renderBrandCard(brand);
  });

  // "+15" button styled as brand card
  if (remaining > 0) {
    html += `
      <div id="showMoreBrands" class="aspect-square rounded-xl bg-[#0F1115] border border-accent/30 flex flex-col items-center justify-center cursor-pointer hover:border-accent transition group">
        <div class="text-3xl font-bold text-accent mb-1 group-hover:scale-110 transition">+${remaining}</div>
        <div class="text-[11px] text-accent/70">–±—Ä–µ–Ω–¥–æ–≤</div>
      </div>
    `;
  }

  html += '</div>';

  // Hidden full list
  if (remaining > 0) {
    html += '<div id="allBrandsList" class="hidden mt-4 grid grid-cols-4 gap-3">';
    brands.slice(15).forEach(brand => {
      html += renderBrandCard(brand);
    });
    html += '</div>';
  }

  container.innerHTML = html;

  // Add click handler for "show more" button
  if (remaining > 0) {
    const showMoreBtn = qs("#showMoreBrands");
    const allBrandsList = qs("#allBrandsList");

    showMoreBtn?.addEventListener("click", () => {
      if (allBrandsList?.classList.contains("hidden")) {
        allBrandsList.classList.remove("hidden");
        showMoreBtn.innerHTML = `
          <div class="text-2xl font-bold text-accent mb-1">‚Üë</div>
          <div class="text-[11px] text-accent/70">–°–∫—Ä—ã—Ç—å</div>
        `;
      } else {
        allBrandsList?.classList.add("hidden");
        showMoreBtn.innerHTML = `
          <div class="text-3xl font-bold text-accent mb-1">+${remaining}</div>
          <div class="text-[11px] text-accent/70">–±—Ä–µ–Ω–¥–æ–≤</div>
        `;
      }
    });
  }
}

// ------------------------------
// ICS generation
// ------------------------------
function escapeICS(text) {
  return String(text || "")
    .replace(/\\/g, "\\\\")
    .replace(/\n/g, "\\n")
    .replace(/,/g, "\\,")
    .replace(/;/g, "\\;");
}

function toICSDateTime(iso) {
  // –æ–∂–∏–¥–∞–µ–º "2026-02-25T09:00:00Z" –∏–ª–∏ –±–µ–∑ Z
  // –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç YYYYMMDDTHHMMSSZ
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return null;

  const pad = (n) => String(n).padStart(2, "0");
  const YYYY = d.getUTCFullYear();
  const MM = pad(d.getUTCMonth() + 1);
  const DD = pad(d.getUTCDate());
  const hh = pad(d.getUTCHours());
  const mm = pad(d.getUTCMinutes());
  const ss = pad(d.getUTCSeconds());
  return `${YYYY}${MM}${DD}T${hh}${mm}${ss}Z`;
}

// ------------------------------
// Init
// ------------------------------
document.addEventListener("DOMContentLoaded", () => {
  // Citizenship
  const citizenshipSelect = qs("#citizenshipSelect");
  if (citizenshipSelect) {
    currentCitizenship = citizenshipSelect.value || "RU";
    citizenshipSelect.addEventListener("change", () => {
      currentCitizenship = citizenshipSelect.value || "RU";
      updateAllVisaTags();
      applyFilters();
      // –µ—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–∏–º –±–µ–π–¥–∂ –≤ –Ω–µ–π
      if (currentEventId) populateModal(currentEventId);
    });
  }

  // Visa tags initial
  updateAllVisaTags();

  // Filters
  qs("#filterSizeBtn")?.addEventListener("click", () => {
    tierFilterIndex = (tierFilterIndex + 1) % TIER_FILTERS.length;
    updateFilterLabels();
    applyFilters();
  });

  qs("#filterVisaBtn")?.addEventListener("click", () => {
    visaFilterIndex = (visaFilterIndex + 1) % VISA_FILTERS.length;
    updateFilterLabels();
    applyFilters();
  });

  updateFilterLabels();
  applyFilters();

  // Modal open: bind all clickable event cards
  qsa(".event-card[data-event-id]").forEach((card) => {
    card.addEventListener("click", () => {
      const id = card.getAttribute("data-event-id");
      if (!id) return;
      populateModal(id);
      openModal();
    });
  });

  // Modal close
  qs("#modalCloseBtn")?.addEventListener("click", closeModal);
  qs("#modalBg")?.addEventListener("click", closeModal);

  // Escape key closes modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeModal();
    }
  });

  // Tabs
  qsa("[data-tab-btn]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tab = btn.getAttribute("data-tab-btn");
      if (tab) setActiveTab(tab);
    });
  });

  // ------------------------------
  // Calendar Export Logic
  // ------------------------------
  initCalendarExport();

  // ------------------------------
  // Access Modal (Lead Capture)
  // ------------------------------
  initAccessModal();
});

// ------------------------------
// Calendar Export Logic
// ------------------------------
const MONTH_MAP_EN = {
  'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
  'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
  'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
};

const MONTH_MAP_RU = {
  '—è–Ω–≤': '01', '—Ñ–µ–≤': '02', '–º–∞—Ä': '03', '–∞–ø—Ä': '04',
  '–º–∞–π': '05', '–∏—é–Ω': '06', '–∏—é–ª': '07', '–∞–≤–≥': '08',
  '—Å–µ–Ω': '09', '–æ–∫—Ç': '10', '–Ω–æ—è': '11', '–¥–µ–∫': '12'
};

function getVisibleEvents() {
  const allCards = qsa('[data-filterable="1"]');
  return allCards.filter(card => {
    // Check if visible
    if (card.offsetParent === null) return false;
    const style = window.getComputedStyle(card);
    if (style.display === 'none') return false;
    if (card.classList.contains('hidden')) return false;
    return true;
  });
}

function initCalendarExport() {
  const addBtn = qs("#addToCalendarBtn");
  const modalAddBtn = qs("#modalAddToCalendarBtn");

  // Main button: add all visible events
  addBtn?.addEventListener("click", () => {
    const visibleCards = getVisibleEvents();
    if (visibleCards.length === 0) {
      alert("–ù–µ—Ç –≤–∏–¥–∏–º—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å");
      return;
    }

    const conferences = visibleCards.map(card => extractConferenceData(card));
    const icsData = generateMultiEventICS(conferences);

    if (icsData) {
      downloadICSFile(icsData, "secretroom-calendar-2026");
    }
  });

  // Modal button: add current event
  modalAddBtn?.addEventListener("click", () => {
    if (!currentEventId) return;

    const ev = EVENTS[currentEventId];
    if (!ev) return;

    const conf = {
      title: ev.title,
      location: `${ev.city}, ${ev.country}`,
      country: ev.country,
      startDate: ev.startISO ? ev.startISO.split('T')[0] : null,
      endDate: ev.endISO ? ev.endISO.split('T')[0] : null,
      isTBD: false,
      description: ev.description || ""
    };

    const icsData = generateMultiEventICS([conf]);
    if (icsData) {
      downloadICSFile(icsData, `${currentEventId}`);
    }
  });
}

function extractConferenceData(card) {
  const data = {
    title: "",
    location: "",
    country: card.getAttribute("data-country") || "",
    startDate: null,
    endDate: null,
    isTBD: false,
    description: ""
  };

  // Extract title
  const titleEl = card.querySelector("h3, .text-sm.font-bold, .font-bold");
  if (titleEl) data.title = titleEl.textContent.trim();

  // Extract location
  const locationEl = card.querySelector("p.text-xs, .text-\\[11px\\]");
  if (locationEl) {
    const locationText = locationEl.textContent.trim();
    data.location = locationText.split("‚Ä¢")[0].trim();
  }

  // Extract dates
  const dataStart = card.getAttribute("data-start");
  const dataEnd = card.getAttribute("data-end");

  if (dataStart && dataEnd) {
    data.startDate = dataStart;
    data.endDate = dataEnd;
  } else {
    // Try to parse from text
    const dateEl = card.querySelector("span.tag");
    if (dateEl) {
      const dateText = dateEl.textContent.trim();
      const parsed = parseDateText(dateText, card);
      data.startDate = parsed.start;
      data.endDate = parsed.end;
      data.isTBD = parsed.isTBD;
    }
  }

  return data;
}

function parseDateText(text, card) {
  const result = { start: null, end: null, isTBD: false };

  // Check for "DD‚ÄìDD Month" format (Russian)
  const ruMatch = text.match(/(\d+)[‚Äì-](\d+)\s+(\S+)/);
  if (ruMatch) {
    const [, startDay, endDay, monthRu] = ruMatch;
    const monthLower = monthRu.toLowerCase().substring(0, 3);
    const month = MONTH_MAP_RU[monthLower];
    if (month) {
      result.start = `2026-${month}-${startDay.padStart(2, '0')}`;
      result.end = `2026-${month}-${endDay.padStart(2, '0')}`;
      return result;
    }
  }

  // Check for TBD format
  if (text.includes("TBD") || text.includes("–î–∞—Ç—ã TBD")) {
    result.isTBD = true;

    // Try to extract month from text
    const monthMatch = text.match(/TBD\s+(\w+)/i);
    let month = null;

    if (monthMatch) {
      const monthStr = monthMatch[1].toLowerCase();
      month = MONTH_MAP_EN[monthStr];
    }

    // Fallback: get month from parent cell
    if (!month) {
      const cell = card.closest(".cell");
      if (cell) {
        const monthNum = cell.querySelector(".month-num");
        if (monthNum) {
          month = monthNum.textContent.trim().padStart(2, '0');
        }
      }
    }

    if (month) {
      result.start = `2026-${month}-01`;
      result.end = `2026-${month}-02`;
    }
  }

  return result;
}

function generateMultiEventICS(conferences) {
  if (!conferences || conferences.length === 0) return null;

  const now = toICSDateTime(new Date().toISOString());
  const events = conferences.map((conf, idx) => {
    if (!conf.startDate || !conf.endDate) return null;

    const uid = `${Date.now()}-${idx}@secretroom-calendar`;
    const dtStart = conf.startDate.replace(/-/g, '');
    const dtEnd = conf.endDate.replace(/-/g, '');

    let description = conf.description || "";
    if (conf.isTBD) {
      description = "‚ö†Ô∏è –î–∞—Ç–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è (TBD). –£—Ç–æ—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–¥ –ø–æ–µ–∑–¥–∫–æ–π.\n\n" + description;
    }

    return `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${now}
DTSTART;VALUE=DATE:${dtStart}
DTEND;VALUE=DATE:${dtEnd}
SUMMARY:${escapeICS(conf.title)}
LOCATION:${escapeICS(conf.location)}
DESCRIPTION:${escapeICS(description)}
END:VEVENT`;
  }).filter(Boolean);

  if (events.length === 0) return null;

  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Secretroom//iGaming Calendar//RU
CALSCALE:GREGORIAN
METHOD:PUBLISH
${events.join('\n')}
END:VCALENDAR`;

  return ics;
}


function downloadICSFile(icsContent, basename) {
  const blob = new Blob([icsContent], { type: "text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${basename}.ics`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

// ------------------------------
// Access Modal Logic
// ------------------------------
const STORAGE_KEY = "igcal_user";
const BOT_USERNAME = "YOUR_TELEGRAM_BOT_USERNAME"; // Replace with your bot username

function normalizeTelegram(input) {
  const trimmed = (input || "").trim();
  if (!trimmed) return "";
  return trimmed.startsWith("@") ? trimmed : `@${trimmed}`;
}

function checkAccess() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return false;
    const data = JSON.parse(stored);
    return !!(data && data.telegram);
  } catch {
    return false;
  }
}

function saveAccess(name, telegram, createdAtISO) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ name, telegram, createdAtISO }));
  } catch (err) {
    console.error("Failed to save to localStorage:", err);
  }
}

function showAccessModal() {
  const overlay = qs("#accessModalOverlay");
  if (!overlay) return;
  overlay.classList.remove("hidden");
}

function hideAccessModal() {
  const overlay = qs("#accessModalOverlay");
  if (!overlay) return;
  overlay.classList.add("hidden");
}

function showError(message) {
  const el = qs("#accessError");
  if (!el) return;
  el.textContent = message;
  el.classList.remove("hidden");
}

function hideError() {
  const el = qs("#accessError");
  if (!el) return;
  el.classList.add("hidden");
}

function showSuccess() {
  const el = qs("#accessSuccess");
  if (!el) return;
  el.classList.remove("hidden");
  setTimeout(() => el.classList.add("hidden"), 2000);
}

function setLoading(isLoading) {
  const btn = qs("#accessSubmitBtn");
  const spinner = qs("#accessBtnSpinner");
  const text = qs("#accessBtnText");
  if (!btn) return;

  if (isLoading) {
    btn.disabled = true;
    spinner?.classList.remove("hidden");
    text?.classList.add("hidden");
  } else {
    btn.disabled = false;
    spinner?.classList.add("hidden");
    text?.classList.remove("hidden");
  }
}

function initTelegramWidget() {
  // Check if bot username is configured
  if (BOT_USERNAME === "YOUR_TELEGRAM_BOT_USERNAME") {
    // Not configured, leave placeholder
    return;
  }

  // Hide placeholder
  const placeholder = qs("#telegramWidgetPlaceholder");
  if (placeholder) placeholder.style.display = "none";

  // Load Telegram Widget script
  const container = qs("#telegramLoginContainer");
  if (!container) return;

  const script = document.createElement("script");
  script.src = "https://telegram.org/js/telegram-widget.js?22";
  script.setAttribute("data-telegram-login", BOT_USERNAME);
  script.setAttribute("data-size", "medium");
  script.setAttribute("data-radius", "12");
  script.setAttribute("data-onauth", "onTelegramAuth(user)");
  script.setAttribute("data-request-access", "write");
  script.async = true;

  container.appendChild(script);
}

// Callback for Telegram Widget
window.onTelegramAuth = function(user) {
  if (!user) return;

  const nameInput = qs("#accessName");
  const telegramInput = qs("#accessTelegram");

  // Prefill fields
  if (user.username && telegramInput) {
    telegramInput.value = normalizeTelegram(user.username);
  }

  if (user.first_name && nameInput) {
    const lastName = user.last_name || "";
    nameInput.value = `${user.first_name} ${lastName}`.trim();
  }

  // Note: We don't auto-check consent, user must do it manually
};

function initAccessModal() {
  // Check if user already has access
  if (checkAccess()) {
    return; // Don't show modal
  }

  // Show modal
  showAccessModal();

  // Initialize Telegram Widget
  initTelegramWidget();

  // Handle form submission
  const accessForm = qs("#accessForm");
  accessForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    hideError();

    const nameInput = qs("#accessName");
    const telegramInput = qs("#accessTelegram");
    const consentInput = qs("#accessConsent");
    const createdAtInput = qs("#accessCreatedAt");
    const userAgentInput = qs("#accessUserAgent");

    const name = nameInput?.value || "";
    const telegram = telegramInput?.value || "";

    // Validation
    if (!name.trim()) {
      showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è");
      return;
    }

    if (!telegram.trim()) {
      showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram");
      return;
    }

    if (!consentInput?.checked) {
      showError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö");
      return;
    }

    // Normalize telegram
    const normalizedTg = normalizeTelegram(telegram);
    if (telegramInput) telegramInput.value = normalizedTg;

    // Fill hidden fields
    const now = new Date().toISOString();
    if (createdAtInput) createdAtInput.value = now;
    if (userAgentInput) userAgentInput.value = navigator.userAgent;

    // Show loading
    setLoading(true);

    // Save to localStorage
    saveAccess(name.trim(), normalizedTg, now);

    // Submit form to iframe
    accessForm.submit();

    // Close modal after short delay
    setTimeout(() => {
      showSuccess();
      setTimeout(() => {
        hideAccessModal();
        setLoading(false);
      }, 1000);
    }, 500);
  });
}
